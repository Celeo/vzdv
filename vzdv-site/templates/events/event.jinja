{% extends "_layout" %}

{% block title %}{{ event.name }} | {{ super() }}{% endblock %}

{% block head_extra %}
<style>
  dialog::backdrop {
    background-color: rgba(255, 255, 255, 0.2);
  }
  dialog {
    background-color: var(--bs-body-bg);
    width: 30%;
    border: none;
    border-radius: 1.5rem;
  }
</style>
{% endblock %}

{% block body %}

<div class="row">
  <div class="col" id="event-">
    <h2>{{ event.name }}</h2>
    <h5 class="pt-3"><strong>Start:</strong> <span class="d-none event-time" updateTarget="editFormStart">{{ event.start }}</span></h5>
    <h5><strong>End:</strong> <span class="d-none event-time" updateTarget="editFormEnd">{{ event.end }}</span></h5>

    <p class="pt-3">{{ event.description }}</p>

    <div class="d-flex justify-content-around">
      {% if user_info and user_info.cid %}
        <button class="btn btn-primary" role="button">
          <i class="bi bi-plus-circle"></i>
          Register
        </button>
      {% endif %}
      {% if is_event_staff %}
        <button role="button" class="btn btn-warning" id="btn-modal-open">
          <i class="bi bi-pencil"></i>
          Edit event
        </button>
        <button role="button" class="btn btn-warning">
          <i class="bi bi-list"></i>
          Edit positions
        </button>
        <button role="button" class="btn btn-danger" id="button-delete">
          <i class="bi bi-trash"></i>
          Delete
        </button>
      {% endif %}
    </div>

  </div>
  <div class="col">
    <img src="{{ event.image_url }}" alt="Event banner" class="img-fluid" />
  </div>
</div>

<div class="row pt-4">
  <div class="col">
    <h4>Enroute Positions</h4>
    <ul class="list-group">
      {% for position in positions %}
        {% if position.category == 'Enroute' %}
          <li class="list-group-item">{{ position.name }} - {{ position.controller }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
  <div class="col">
    <h4>TRACON Positions</h4>
    <ul class="list-group">
      {% for position in positions %}
        {% if position.category == 'TRACON' %}
          <li class="list-group-item">{{ position.name }} - {{ position.controller }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
  <div class="col">
    <h4>Local Positions</h4>
    <ul class="list-group">
      {% for position in positions %}
        {% if position.category == 'Local' %}
          <li class="list-group-item">{{ position.name }} - {{ position.controller }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
</div>

{% if is_event_staff %}
  <div class="pt-3"></div>
  <hr />
  <h2>Sign-ups</h2>
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Controller</th>
        <th>Choice 1</th>
        <th>Choice 2</th>
        <th>Choice 3</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      {% for registration in registrations %}
        <tr>
          <td>{{ registration.controller }}</td>
          <td>{{ registration.choice_1 }}</td>
          <td>{{ registration.choice_2 }}</td>
          <td>{{ registration.choice_3 }}</td>
          <td>{{ registration.notes }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

<dialog id="modalEditForm">
  <h2 class="pb-3">Edit event</h2>
  <form action="/events/{{ event.id }}" method="POST">
    <div class="row">
      <div class="col">
        <input type="hidden" name="timezone" id="input-timezone">
        <div class="mb-3">
          <label for="name" class="form-label">Event name</label>
          <input type="text" class="form-control" name="name" value="{{ event.name }}" required>
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea name="description" class="form-control">{{ event.description }}</textarea>
        </div>
        <div class="mb-3">
          <label for="banner" class="form-label">Banner URL</label>
          <input type="text" class="form-control" name="banner" value="{{ event.image_url }}" required>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" value="" id="published" name="published" {% if event.published %}checked{% endif %}>
          <label class="form-check-label" for="published">
            Published
          </label>
        </div>
        <div class="row mb-3">
          <div class="col">
            <label for="start" class="form-label">Start</label>
            <input type="datetime-local" name="start" id="editFormStart" class="form-control" required>
          </div>
          <div class="col">
            <label for="end" class="form-label">End</label>
            <input type="datetime-local" name="end" id="editFormEnd" class="form-control" required>
          </div>
        </div>
        <div class="d-flex justify-content-between">
          <button class="btn btn-warning" role="button" id="btn-modal-close">Close</button>
          <button class="btn btn-primary" role="button" type="submit">Save</button>
        </div>
      </div>
    </div>
  </form>
</dialog>

<script defer>
  document.querySelectorAll('.event-time').forEach((element) => {
    const date = new Date(element.innerText);
    element.innerText = date.toLocaleDateString('en-US',
      { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' }
    );
    element.classList.remove('d-none');
    element.classList.remove('event-time');

    // this is annoying
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const dom = date.getDate().toString().padStart(2, '0');
    const hour = date.getHours().toString().padStart(2, '0');
    const minute = date.getMinutes().toString().padStart(2, '0');
    document.getElementById(element.getAttribute('updateTarget')).value = `${year}-${month}-${dom}T${hour}:${minute}`;
  });
  document.getElementById('input-timezone').value = Intl.DateTimeFormat().resolvedOptions().timeZone;

  document.getElementById('button-delete').addEventListener('click', (e) => {
    e.preventDefault();
    const result = window.confirm('Are you sure you want to delete this event?');
    if (result) {
      fetch('/events/{{ event.id }}', { method: 'DELETE' })
        .then((response) => {
          if (response.status === 200 ) {
            window.location = '/events/';
          } else {
            console.error(response);
            window.alert(`Something went wrong; got status ${response.status}`);
          }
        })
        .catch((error) => {
          console.error(error);
          window.alert(`Something went wrong: ${error}`);
        });
    }
  });

  document.getElementById('btn-modal-open').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('modalEditForm').showModal();
  });
  document.getElementById('btn-modal-close').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('modalEditForm').close();
  });
</script>

{% endblock %}
